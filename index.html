<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>경찰과 도둑</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuEXGFg6CP-WFTf8e_EcMBpQ3x-KKthc4" defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 1rem;
      background: #f0f0f0;
    }
    h1 {
      text-align: center;
    }
    #form {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #username, #role {
      padding: 8px;
      font-size: 1rem;
    }
    #start {
      padding: 8px 12px;
      font-size: 1rem;
      cursor: pointer;
    }
    #map {
      height: 80vh;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>🚨 경찰과 도둑 위치 추적 게임</h1>

  <div id="form">
    <input type="text" id="username" placeholder="닉네임 입력" />
    <select id="role">
      <option value="police">👮 경찰</option>
      <option value="thief">🕵️ 도둑</option>
    </select>
    <button id="start">게임 시작</button>
  </div>

  <div id="map"></div>

  <!-- Firebase + 앱 로직 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    let map, userMarker;
    let markers = {};
    let userId = null;
    let username = null;
    let role = null;
    let db, usersRef;

    function initFirebase() {
      const firebaseConfig = {
        apiKey: "AIzaSyAVPD6hJVl4vqJac24cLzI-B3ToGLKinfI",
        authDomain: "waterdragon-499c9.firebaseapp.com",
        databaseURL: "https://waterdragon-499c9-default-rtdb.firebaseio.com",
        projectId: "waterdragon-499c9",
        storageBucket: "waterdragon-499c9.firebasestorage.app",
        messagingSenderId: "756466741361",
        appId: "1:756466741361:web:02c489c252763a6d3eebd0"
      };

      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      usersRef = ref(db, "users");
    }

    function initMap(lat = 37.5665, lng = 126.9780) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat, lng },
        zoom: 15,
      });
    }

    function updateMarker(userId, data) {
      if (!data.lat || !data.lng) return;

      const position = { lat: data.lat, lng: data.lng };
      if (markers[userId]) {
        markers[userId].setPosition(position);
      } else {
        const color = data.role === "police" ? "blue" : "red";
        const marker = new google.maps.Marker({
          position,
          map,
          label: {
            text: data.username,
            color: color,
            fontWeight: "bold",
          },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: color,
            fillOpacity: 0.6,
            strokeWeight: 1,
            strokeColor: "white",
          },
        });
        markers[userId] = marker;
      }
    }

    function clearMarkers() {
      Object.values(markers).forEach((marker) => marker.setMap(null));
      markers = {};
    }

    function watchPositions() {
      if (!navigator.geolocation) {
        alert("위치 정보가 지원되지 않는 기기입니다.");
        return;
      }

      function sendPosition(position) {
        const { latitude, longitude } = position.coords;
        set(ref(db, "users/" + userId), {
          username,
          role,
          lat: latitude,
          lng: longitude,
          timestamp: Date.now(),
        });
        if (!userMarker) {
          userMarker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude },
            map,
            label: {
              text: username + " (나)",
              color: "black",
              fontWeight: "bold",
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: "green",
              fillOpacity: 0.8,
              strokeWeight: 2,
              strokeColor: "white",
            },
          });
          map.setCenter({ lat: latitude, lng: longitude });
        } else {
          userMarker.setPosition({ lat: latitude, lng: longitude });
        }
      }

      navigator.geolocation.getCurrentPosition(sendPosition);
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(sendPosition);
      }, 3 * 60 * 1000);
    }

    function startGame() {
      username = document.getElementById("username").value.trim();
      role = document.getElementById("role").value;

      if (!username) {
        alert("닉네임을 입력하세요.");
        return;
      }

      userId = username + "_" + Date.now();

      document.getElementById("form").style.display = "none";

      initMap();

      watchPositions();

      onValue(usersRef, (snapshot) => {
        const users = snapshot.val();
        clearMarkers();

        for (const [uid, data] of Object.entries(users || {})) {
          updateMarker(uid, data);
        }
      });
    }

    window.addEventListener("load", () => {
      initFirebase();

      document.getElementById("start").addEventListener("click", startGame);
    });

    // 서비스워커 등록 (PWA 필수)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").then(() => {
        console.log("서비스워커 등록 완료");
      });
    }
  </script>

</body>
</html>
