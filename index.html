<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>경찰과 도둑</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuEXGFg6CP-WFTf8e_EcMBpQ3x-KKthc4" defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 1rem;
      background: #f0f0f0;
    }
    h1 {
      text-align: center;
    }
    #form {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #username, #role {
      padding: 8px;
      font-size: 1rem;
    }
    #start {
      padding: 8px 12px;
      font-size: 1rem;
      cursor: pointer;
    }
    #map {
      height: 80vh;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>🚨 경찰과 도둑 위치 추적 게임</h1>

  <div id="form">
    <input type="text" id="username" placeholder="닉네임 입력" />
    <select id="role">
      <option value="police">👮 경찰</option>
      <option value="thief">🕵️ 도둑</option>
    </select>
    <button id="start">게임 시작</button>
  </div>


  <div id="arrow-container" style="display:none; text-align:center; margin-top:40px;">
    <div style="font-size:1.2rem; margin-bottom:1rem;">도둑의 방향</div>
    <div id="arrow" style="display:inline-block; transition: transform 0.3s;">
      <svg width="80" height="80" viewBox="0 0 80 80">
        <polygon points="40,10 70,70 40,55 10,70" fill="#1976d2"/>
      </svg>
    </div>
    <div id="distance" style="font-size:1.2rem; margin-top:1rem;"></div>
  </div>


  <!-- Firebase + 앱 로직 (지도 없이 방향/거리만 표시) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    let userId = null;
    let username = null;
    let role = null;
    let db, usersRef;
    let myLat = null, myLng = null;

    function initFirebase() {
      const firebaseConfig = {
        apiKey: "AIzaSyAVPD6hJVl4vqJac24cLzI-B3ToGLKinfI",
        authDomain: "waterdragon-499c9.firebaseapp.com",
        databaseURL: "https://waterdragon-499c9-default-rtdb.firebaseio.com",
        projectId: "waterdragon-499c9",
        storageBucket: "waterdragon-499c9.firebasestorage.app",
        messagingSenderId: "756466741361",
        appId: "1:756466741361:web:02c489c252763a6d3eebd0"
      };
      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      usersRef = ref(db, "users");
    }

    // 두 좌표간 거리(meter)
    function getDistance(lat1, lng1, lat2, lng2) {
      function toRad(deg) { return deg * Math.PI / 180; }
      const R = 6371000; // m
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return Math.round(R * c);
    }

    // 두 좌표간 방위각(0~360deg, 북=0)
    function getAngle(from, to) {
      const toRad = deg => deg * Math.PI / 180;
      const dLng = toRad(to.lng - from.lng);
      const y = Math.sin(dLng) * Math.cos(toRad(to.lat));
      const x = Math.cos(toRad(from.lat)) * Math.sin(toRad(to.lat)) -
                Math.sin(toRad(from.lat)) * Math.cos(toRad(to.lat)) * Math.cos(dLng);
      const brng = Math.atan2(y, x);
      return (brng * 180 / Math.PI + 360) % 360;
    }

    function updateArrowAndDistance(thief, police) {
      if (!thief || !police) return;
      const angle = getAngle(police, thief);
      const dist = getDistance(police.lat, police.lng, thief.lat, thief.lng);
      const arrow = document.getElementById("arrow");
      const distance = document.getElementById("distance");
      arrow.style.transform = `rotate(${angle}deg)`;
      distance.innerText = `도둑까지 거리: ${dist}m`;
      arrow.style.display = "inline-block";
      distance.style.display = "block";
    }

    function watchPositions() {
      if (!navigator.geolocation) {
        alert("위치 정보가 지원되지 않는 기기입니다.");
        return;
      }
      function sendPosition(position) {
        const { latitude, longitude } = position.coords;
        myLat = latitude;
        myLng = longitude;
        set(ref(db, "users/" + userId), {
          username,
          role,
          lat: latitude,
          lng: longitude,
          timestamp: Date.now(),
        });
      }
      navigator.geolocation.getCurrentPosition(sendPosition);
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(sendPosition);
      }, 3 * 1000); // 3초마다 갱신
    }

    function startGame() {
      username = document.getElementById("username").value.trim();
      role = document.getElementById("role").value;
      if (!username) {
        alert("닉네임을 입력하세요.");
        return;
      }
      userId = username + "_" + Date.now();
      document.getElementById("form").style.display = "none";
      document.getElementById("map").style.display = "none";
      document.getElementById("arrow-container").style.display = "block";
      watchPositions();
      onValue(usersRef, (snapshot) => {
        const users = snapshot.val() || {};
        if (role === "police") {
          // 내 위치
          const myData = users[userId];
          // 모든 도둑 중 가장 가까운 도둑 찾기
          let minDist = Infinity, nearestThief = null;
          for (const [uid, data] of Object.entries(users)) {
            if (data.role === "thief" && typeof data.lat === "number" && typeof data.lng === "number") {
              const dist = myData && typeof myData.lat === "number" && typeof myData.lng === "number"
                ? getDistance(myData.lat, myData.lng, data.lat, data.lng)
                : Infinity;
              if (dist < minDist) {
                minDist = dist;
                nearestThief = data;
              }
            }
          }
          if (myData && nearestThief) {
            updateArrowAndDistance(nearestThief, myData);
          } else {
            document.getElementById("arrow").style.display = "none";
            document.getElementById("distance").style.display = "none";
          }
        } else {
          // 도둑은 화살표/거리 안보임
          document.getElementById("arrow").style.display = "none";
          document.getElementById("distance").style.display = "none";
        }
      });
    }

    window.addEventListener("load", () => {
      initFirebase();
      document.getElementById("start").addEventListener("click", startGame);
    });

    // 서비스워커 등록 (PWA 필수)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").then(() => {
        console.log("서비스워커 등록 완료");
      });
    }
  </script>

</body>
</html>
