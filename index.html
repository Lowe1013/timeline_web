<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>경찰/도둑 위치 추적</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0; background: #111; color: white; font-family: sans-serif;
      display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
    }
    #arrow {
      width: 100px; height: 100px;
      margin: 30px auto 10px auto;
      transition: transform 0.5s;
      display: none;
    }
    #distance {
      font-size: 1.5rem;
      margin-bottom: 20px;
      display: none;
    }
    #roleForm {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <form id="roleForm">
    <input id="userId" placeholder="닉네임(영문)" required>
    <select id="role">
      <option value="police">경찰</option>
      <option value="thief">도둑</option>
    </select>
    <button type="submit">시작</button>
  </form>
  <div id="distance"></div>
  <div id="arrow">
    <!-- SVG 화살표 -->
    <svg width="100" height="100" viewBox="0 0 100 100">
      <polygon points="50,10 90,90 50,70 10,90" fill="#00bfff"/>
    </svg>
  </div>
  <button id="requestPermission" style="display:none;">기기 방향 권한 요청</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVPD6hJVl4vqJac24cLzI-B3ToGLKinfI",
      authDomain: "waterdragon-499c9.firebaseapp.com",
      databaseURL: "https://waterdragon-499c9-default-rtdb.firebaseio.com",
      projectId: "waterdragon-499c9",
      storageBucket: "waterdragon-499c9.appspot.com",
      messagingSenderId: "756466741361",
      appId: "1:756466741361:web:02c489c252763a6d3eebd0",
      measurementId: "G-NTWZSEJBWZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId, myRole, myRef;
    let myPosition = null;
    let heading = 0;

    document.getElementById("roleForm").onsubmit = async e => {
      e.preventDefault();
      myId = document.getElementById("userId").value.trim();
      myRole = document.getElementById("role").value;
      if (!myId) return alert("닉네임을 입력하세요.");
      myRef = ref(db, 'users/' + myId);

      document.getElementById("roleForm").style.display = "none";

      // 도둑: 안내문구/위치전송, 경찰: 화살표/거리 UI
      if (myRole === "police") {
        document.getElementById("arrow").style.display = "block";
        document.getElementById("distance").style.display = "block";
        document.getElementById("requestPermission").style.display = "block";
        startPolice();
      } else {
        // 도둑 안내문구 표시
        const thiefMsg = document.createElement("div");
        thiefMsg.style.fontSize = "2rem";
        thiefMsg.style.margin = "40px 0 10px 0";
        thiefMsg.style.textAlign = "center";
        thiefMsg.innerText = "도망치세요!";
        document.body.appendChild(thiefMsg);
        const thiefSub = document.createElement("div");
        thiefSub.style.fontSize = "1.1rem";
        thiefSub.style.textAlign = "center";
        thiefSub.innerText = "위치 정보가 30초마다 전송됩니다";
        document.body.appendChild(thiefSub);
        startThief();
      }
    };

    function sendMyLocation() {
      if (!myRef) return;
      navigator.geolocation.getCurrentPosition(pos => {
        set(myRef, {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          role: myRole,
          timestamp: Date.now()
        });
      });
    }

    function startThief() {
      sendMyLocation();
      setInterval(sendMyLocation, 30000); // 30초마다 전송
      navigator.geolocation.watchPosition(pos => {
        myPosition = pos.coords;
        // 30초마다만 전송, watchPosition에서는 전송하지 않음
      });
    }

    function startPolice() {
      sendMyLocation();
      setInterval(sendMyLocation, 3000);
      navigator.geolocation.watchPosition(pos => {
        myPosition = pos.coords;
        sendMyLocation();
        updateArrowAndDistance();
      });

      // 모든 유저 위치 실시간 감시
      onValue(ref(db, 'users'), snapshot => {
        window.allUsers = snapshot.val() || {};
        updateArrowAndDistance();
      });

      // 방향 센서
      document.getElementById("requestPermission").onclick = () => {
        if (typeof DeviceOrientationEvent !== 'undefined' &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientation', handleOrientation);
              alert("기기 방향 감지 허용됨");
            }
          }).catch(console.error);
        } else {
          window.addEventListener('deviceorientation', handleOrientation);
          alert("기기 방향 감지 시작됨");
        }
      };
    }

    function handleOrientation(event) {
      heading = event.alpha ?? 0;
      updateArrowAndDistance();
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      // Haversine formula
      const R = 6371000;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return Math.round(R * c);
    }

    function getBearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
      const bearing = Math.atan2(y, x);
      return (bearing * 180 / Math.PI + 360) % 360;
    }

    function updateArrowAndDistance() {
      if (!myPosition || !window.allUsers) return;
      // 내 자신 제외, 도둑만 필터
      const thieves = Object.entries(window.allUsers)
        .filter(([id, u]) => u.role === "thief" && id !== myId && u.lat && u.lng);

      if (thieves.length === 0) {
        document.getElementById("distance").innerText = "주변 도둑 없음";
        document.getElementById("arrow").style.opacity = 0.3;
        return;
      }

      // 가장 가까운 도둑 찾기
      let minDist = Infinity, nearest = null;
      for (const [id, u] of thieves) {
        const dist = getDistance(myPosition.latitude, myPosition.longitude, u.lat, u.lng);
        if (dist < minDist) {
          minDist = dist;
          nearest = u;
        }
      }

      // 거리 표시
      document.getElementById("distance").innerText = `도둑까지 거리: ${minDist}m`;

      // 방향 표시 (heading 보정: iOS/Android 모두 북쪽 기준, alpha=0이 북쪽)
      const bearing = getBearing(
        myPosition.latitude, myPosition.longitude,
        nearest.lat, nearest.lng
      );
      // 일부 브라우저는 alpha가 시계방향, 일부는 반시계방향이므로, 두 방식 모두 시도
      let adjusted = (bearing - heading + 360) % 360;
      // iOS Safari는 alpha가 반시계방향이므로, 오차가 크면 반대로도 시도
      if (Math.abs(adjusted - bearing) > 180) {
        adjusted = (bearing + heading) % 360;
      }
      document.getElementById("arrow").style.transform = `rotate(${adjusted}deg)`;
      document.getElementById("arrow").style.opacity = 1;
    }
  </script>
</body>
</html>
